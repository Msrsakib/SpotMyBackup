<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Porter - Full Library Transfer</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; text-align: center; padding: 50px; }
        .card { background: #181818; padding: 40px; border-radius: 20px; display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 600px; width: 90%; }
        h1 { color: #1DB954; }
        .btn { background: #1DB954; color: white; padding: 15px 30px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; margin: 10px; transition: 0.3s; width: 250px; }
        .btn:hover { background: #1ed760; transform: scale(1.02); }
        .btn-secondary { background: #333; }
        #status { margin-top: 20px; color: #b3b3b3; white-space: pre-wrap; line-height: 1.6; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>Spotify Library Porter</h1>
    <p>Backup all Playlists & Liked Songs into one file.</p>
    
    <div id="login-section">
        <button class="btn" onclick="redirectToSpotify()">Connect Spotify</button>
    </div>

    <div id="action-section" style="display:none;">
        <button class="btn" onclick="exportFullLibrary()">Export Full Library</button>
        <br>
        <input type="file" id="importFile" onchange="importLibrary(event)">
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Library File</button>
    </div>

    <div id="status">Status: Waiting for connection...</div>
</div>

<script>
    /* --- CONFIGURATION --- */
    const clientId = '10894b5f6e264203ac55e860682458a4'; // Put your Client ID here
    const redirectUri = window.location.origin + window.location.pathname;
    const scope = 'playlist-read-private playlist-modify-public playlist-modify-private user-library-read user-library-modify';

    /* --- AUTH & PKCE --- */
    async function redirectToSpotify() {
        const verifier = generateRandomString(64);
        window.localStorage.setItem('code_verifier', verifier);
        const challenge = await generateCodeChallenge(verifier);
        const params = new URLSearchParams({
            client_id: clientId, response_type: 'code', redirect_uri: redirectUri,
            code_challenge_method: 'S256', code_challenge: challenge, scope: scope
        });
        window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
    }

    async function getToken(code) {
        const params = new URLSearchParams({
            client_id: clientId, grant_type: 'authorization_code', code: code,
            redirect_uri: redirectUri, code_verifier: window.localStorage.getItem('code_verifier')
        });
        const res = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params
        });
        return await res.json();
    }

    /* --- EXPORT FULL LIBRARY --- */
    async function exportFullLibrary() {
        updateStatus("Initializing Export...\nFetching Liked Songs & Playlists.");
        const token = window.localStorage.getItem('access_token');
        let fullBackup = [];

        // 1. Fetch Liked Songs
        updateStatus("Fetching Liked Songs...");
        let likedSongs = [];
        let nextLiked = 'https://api.spotify.com/v1/me/tracks?limit=50';
        while(nextLiked) {
            const res = await fetch(nextLiked, { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();
            likedSongs.push(...data.items.map(i => i.track.uri));
            nextLiked = data.next;
        }
        if (likedSongs.length > 0) {
            fullBackup.push({ name: "Liked Songs Backup", tracks: likedSongs });
        }

        // 2. Fetch All Playlists
        updateStatus("Fetching Playlists...");
        const plRes = await fetch('https://api.spotify.com/v1/me/playlists?limit=50', { headers: {'Authorization': `Bearer ${token}`} });
        const plData = await plRes.json();

        for (let pl of plData.items) {
            updateStatus(`Downloading track list: ${pl.name}`);
            let tracks = [];
            let nextTracks = pl.tracks.href;
            while(nextTracks) {
                const tRes = await fetch(nextTracks, { headers: {'Authorization': `Bearer ${token}`} });
                const tData = await tRes.json();
                tracks.push(...tData.items.filter(i => i.track).map(i => i.track.uri));
                nextTracks = tData.next;
            }
            fullBackup.push({ name: pl.name, tracks: tracks });
        }

        const blob = new Blob([JSON.stringify(fullBackup, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Spotify_Full_Backup_${new Date().toLocaleDateString()}.json`;
        a.click();
        updateStatus("Export Complete! JSON file downloaded.");
    }

    /* --- IMPORT FULL LIBRARY --- */
    async function importLibrary(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const backupData = JSON.parse(e.target.result);
            const token = window.localStorage.getItem('access_token');
            const meRes = await fetch('https://api.spotify.com/v1/me', { headers: {'Authorization': `Bearer ${token}`} });
            const user = await meRes.json();

            for (let pl of backupData) {
                if (pl.name === "Liked Songs Backup") {
                    updateStatus("Importing Liked Songs (this takes time)...");
                    for (let i = 0; i < pl.tracks.length; i += 50) {
                        const ids = pl.tracks.slice(i, i + 50).map(uri => uri.split(':')[2]);
                        await fetch(`https://api.spotify.com/v1/me/tracks?ids=${ids.join(',')}`, {
                            method: 'PUT', headers: {'Authorization': `Bearer ${token}`}
                        });
                        updateStatus(`Liked Songs: ${i + ids.length} tracks imported.`);
                    }
                } else {
                    updateStatus(`Creating Playlist: ${pl.name}`);
                    const createRes = await fetch(`https://api.spotify.com/v1/users/${user.id}/playlists`, {
                        method: 'POST', headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
                        body: JSON.stringify({ name: pl.name, public: false })
                    });
                    const newPl = await createRes.json();
                    
                    if (newPl.id && pl.tracks.length > 0) {
                        for (let i = 0; i < pl.tracks.length; i += 100) {
                            await fetch(`https://api.spotify.com/v1/playlists/${newPl.id}/tracks`, {
                                method: 'POST', headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
                                body: JSON.stringify({ uris: pl.tracks.slice(i, i + 100) })
                            });
                        }
                    }
                }
                await new Promise(r => setTimeout(r, 400));
            }
            updateStatus("Full Import Completed Successfully!");
        };
        reader.readAsText(file);
    }

    /* --- CORE HELPERS --- */
    function updateStatus(msg) { document.getElementById('status').innerText = "Status: " + msg; }
    
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    if (code) {
        getToken(code).then(data => {
            if (data.access_token) {
                window.localStorage.setItem('access_token', data.access_token);
                window.history.replaceState({}, document.title, window.location.pathname);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('action-section').style.display = 'block';
                updateStatus("Connected!");
            }
        });
    }

    function generateRandomString(length) {
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const values = crypto.getRandomValues(new Uint8Array(length));
        return Array.from(values).map(x => possible[x % possible.length]).join('');
    }

    async function generateCodeChallenge(codeVerifier) {
        const data = new TextEncoder().encode(codeVerifier);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return btoa(String.fromCharCode.apply(null, new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
</script>
</body>
</html>
