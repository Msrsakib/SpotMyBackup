<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Spotify Playlist Transfer (PKCE)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; text-align: center; padding: 50px; }
        .card { background: #181818; padding: 30px; border-radius: 15px; display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn { background: #1DB954; color: white; padding: 12px 25px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; margin: 10px; transition: 0.3s; }
        .btn:hover { background: #1ed760; transform: scale(1.05); }
        .btn-secondary { background: #333; }
        #status { margin-top: 20px; color: #b3b3b3; }
    </style>
</head>
<body>

<div class="card">
    <h1>Spotify Playlist Tool</h1>
    <p>Backup & Restore Playlists (PKCE Standard)</p>
    
    <div id="login-section">
        <button class="btn" onclick="redirectToSpotify()">Connect Spotify</button>
    </div>

    <div id="action-section" style="display:none;">
        <button class="btn" onclick="exportPlaylists()">Export Playlists to JSON</button>
        <br>
        <input type="file" id="importFile" style="display:none" onchange="importPlaylists(event)">
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import JSON to this Account</button>
    </div>

    <div id="status">Status: Waiting for login...</div>
</div>

<script>
    // --- CONFIGURATION ---
    const clientId = '10894b5f6e264203ac55e860682458a4';
    const redirectUri = window.location.origin + window.location.pathname;
    const scope = 'playlist-read-private playlist-modify-public playlist-modify-private';

    // --- PKCE & AUTH LOGIC ---
    async function redirectToSpotify() {
        const verifier = generateRandomString(64);
        window.localStorage.setItem('code_verifier', verifier);
        const challenge = await generateCodeChallenge(verifier);

        const params = new URLSearchParams({
            client_id: clientId,
            response_type: 'code',
            redirect_uri: redirectUri,
            code_challenge_method: 'S256',
            code_challenge: challenge,
            scope: scope
        });

        window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
    }

    async function getToken(code) {
        const codeVerifier = window.localStorage.getItem('code_verifier');
        const params = new URLSearchParams({
            client_id: clientId,
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: redirectUri,
            code_verifier: codeVerifier
        });

        const response = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        return await response.json();
    }

    // --- EXPORT & IMPORT LOGIC ---
    async function exportPlaylists() {
        document.getElementById('status').innerText = "Fetching playlists...";
        const token = window.localStorage.getItem('access_token');
        const res = await fetch('https://api.spotify.com/v1/me/playlists', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        const blob = new Blob([JSON.stringify(data.items, null, 2)], {type : 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'spotify_playlists_backup.json';
        a.click();
        document.getElementById('status').innerText = "Backup downloaded!";
    }

    async function importPlaylists(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const playlists = JSON.parse(e.target.result);
            const token = window.localStorage.getItem('access_token');
            document.getElementById('status').innerText = "Importing... please wait.";

            for (let pl of playlists) {
                // Create new playlist
                const createRes = await fetch(`https://api.spotify.com/v1/me/playlists`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: pl.name, public: false })
                });
                console.log(`Created: ${pl.name}`);
            }
            document.getElementById('status').innerText = "Import complete!";
        };
        reader.readAsText(file);
    }

    // --- INITIALIZE ---
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    if (code) {
        getToken(code).then(data => {
            window.localStorage.setItem('access_token', data.access_token);
            window.history.replaceState({}, document.title, window.location.pathname);
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('action-section').style.display = 'block';
            document.getElementById('status').innerText = "Connected!";
        });
    }

    // --- HELPERS ---
    function generateRandomString(length) {
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        return Array.from(crypto.getRandomValues(new Uint8Array(length)))
            .map(x => possible[x % possible.length]).join('');
    }

    async function generateCodeChallenge(codeVerifier) {
        const data = new TextEncoder().encode(codeVerifier);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
</script>
</body>
</html>
