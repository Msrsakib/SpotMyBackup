<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotify Porter - Full Suite</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; padding: 50px; }
        .card { background: #181818; padding: 40px; border-radius: 20px; display: inline-block; width: 90%; max-width: 500px; border: 1px solid #333; }
        .btn { background: #1DB954; color: white; padding: 15px 30px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; font-size: 16px; }
        #status { margin-top: 20px; color: #b3b3b3; font-size: 14px; background: #222; padding: 15px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h1 style="color: #1DB954;">Spotify Porter</h1>
    <p>Backup Tracks, Playlists & Artists</p>
    
    <div id="login-section">
        <button id="connectBtn" class="btn" onclick="startLogin()">Connect with Spotify</button>
    </div>

    <div id="action-section" style="display:none;">
        <button class="btn" onclick="exportData()">Download Backup</button>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importData(event)">
        <button class="btn" style="background:#444" onclick="document.getElementById('fileInput').click()">Restore Everything</button>
    </div>

    <div id="status">Status: Ready to connect</div>
</div>

<script>
    // আপনার অরিজিনাল Client ID এখানে দিন
    const clientId = '10894b5f6e264203ac55e860682458a4'; 
    const redirectUri = window.location.origin + window.location.pathname;
    let accessToken = '';

    // ১. লগইন ফাংশন (সহজ এবং সরাসরি)
    async function startLogin() {
        console.log("Login button clicked"); // চেক করার জন্য
        try {
            const verifier = generateRandomString(64);
            window.localStorage.setItem('code_verifier', verifier);
            const challenge = await generateCodeChallenge(verifier);
            
            const scope = 'playlist-read-private playlist-modify-public playlist-modify-private user-library-read user-library-modify user-follow-read user-follow-modify';
            
            const authUrl = new URL("https://accounts.spotify.com/authorize");
            const params = {
                client_id: clientId,
                response_type: 'code',
                redirect_uri: redirectUri,
                code_challenge_method: 'S256',
                code_challenge: challenge,
                scope: scope
            };

            authUrl.search = new URLSearchParams(params).toString();
            console.log("Redirecting to:", authUrl.toString());
            window.location.href = authUrl.toString();
        } catch (error) {
            alert("Error: " + error.message);
            console.error(error);
        }
    }

    // ২. টোকেন আনা
    async function fetchToken(code) {
        const verifier = window.localStorage.getItem('code_verifier');
        const params = new URLSearchParams({
            client_id: clientId,
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: redirectUri,
            code_verifier: verifier
        });

        const res = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        return await res.json();
    }

    // ৩. এক্সপোর্ট (আর্টিস্টসহ)
    async function exportData() {
        updateStatus("Starting Export...");
        let collections = { saved: [], playlists: {}, followedArtists: [] };
        try {
            // Artists
            const aRes = await fetch('https://api.spotify.com/v1/me/following?type=artist', { headers: {'Authorization': 'Bearer ' + accessToken} }).then(r => r.json());
            if(aRes.artists) aRes.artists.items.forEach(a => collections.followedArtists.push(a.id));

            // Tracks
            let trackRes = await fetch('https://api.spotify.com/v1/me/tracks', { headers: {'Authorization': 'Bearer ' + accessToken} }).then(r => r.json());
            trackRes.items.forEach(i => collections.saved.push({ id: i.track.id, uri: i.track.uri }));

            // Download
            const blob = new Blob([JSON.stringify(collections)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Spotify_Backup.json`;
            a.click();
            updateStatus("Export Finished!");
        } catch (e) { alert("Export Error: " + e.message); }
    }

    // --- রিডাইরেক্ট হ্যান্ডলিং ---
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    if (code) {
        fetchToken(code).then(data => {
            if (data.access_token) {
                accessToken = data.access_token;
                window.history.replaceState({}, document.title, window.location.pathname);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('action-section').style.display = 'block';
                updateStatus("Connected!");
            } else {
                updateStatus("Token Error: Check Client ID/Secret");
            }
        });
    }

    // হেল্পার ফাংশন
    function updateStatus(msg) { document.getElementById('status').innerText = "Status: " + msg; }
    function generateRandomString(l) { return Array.from(crypto.getRandomValues(new Uint8Array(l))).map(x => 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[x % 62]).join(''); }
    async function generateCodeChallenge(v) {
        const d = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(v));
        return btoa(String.fromCharCode(...new Uint8Array(d))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
</script>
</body>
</html>
